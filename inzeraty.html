<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Inzeráty – Vonky Market</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="header">
    <img src="img/logo.png" alt="Pi logo" class="logo" />
    <h1>Inzeráty</h1>
  </div>
  <nav class="nav-grid">
    <a href="index.html">Domů</a>
    <a href="profil.html">Profil</a>
    <a href="zabava.html">Zábava</a>
  </nav>
  <main class="main-content">
    <section id="adFormSection" style="margin-bottom:2em;"></section>
    <section>
      <h3>Seznam inzerátů</h3>
      <div id="adList"></div>
    </section>
  </main>
  <footer>
    &copy; 2025 Vonkys666
  </footer>
  <script type="module">
    import { auth, db } from "./firebase-config.js";
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      collection, addDoc, getDocs, serverTimestamp, query, orderBy
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const adFormSection = document.getElementById('adFormSection');
    const adList = document.getElementById('adList');

    function renderAds(ads) {
      adList.innerHTML = '';
      ads.forEach(ad => {
        adList.innerHTML += `
          <div class="ad-card">
            <strong>${ad.title}</strong> – <em>${ad.category}</em><br>
            ${ad.description}<br>
            <strong>${ad.price} π</strong><br>
            ${ad.image ? `<img src="${ad.image}" alt="obrázek">` : ''}
            <p><small>Autor: ${ad.authorEmail ? ad.authorEmail : 'Anonym'}</small></p>
          </div>
        `;
      });
    }

    async function loadAds() {
      const q = query(collection(db, "inzeraty"), orderBy("created", "desc"));
      const snapshot = await getDocs(q);
      const ads = [];
      snapshot.forEach(doc => {
        ads.push(doc.data());
      });
      renderAds(ads);
    }

    function adFormHtml() {
      return `
        <h3 id="formTitle">Přidat inzerát</h3>
        <form id="adForm" enctype="multipart/form-data">
          <label>Název:<br><input type="text" name="title" required></label><br><br>
          <label>Popis:<br><textarea name="description" required></textarea></label><br><br>
          <label>Cena (v Pi):<br><input type="number" name="price" required></label><br><br>
          <label>Kategorie:<br>
            <select name="category">
              <option>Zvířata</option>
              <option>Auto-moto</option>
              <option>Elektronika</option>
              <option>Oblečení</option>
              <option>Knihy</option>
              <option>Domácnost</option>
              <option>Pi projekty</option>
              <option>Ostatní</option>
            </select>
          </label><br><br>
          <label>Obrázek (nahrát):<br><input type="file" name="image" accept="image/*"></label><br><br>
          <button type="submit">Přidat inzerát</button>
        </form>
        <div id="msg" style="margin:1em 0; color:crimson;"></div>
      `;
    }

    onAuthStateChanged(auth, user => {
      if (user) {
        adFormSection.innerHTML = adFormHtml();
        document.getElementById('adForm').onsubmit = async e => {
          e.preventDefault();
          const form = e.target;
          const formData = new FormData(form);
          let imageBase64 = '';
          const file = formData.get('image');
          if (file && file.size > 0) {
            const reader = new FileReader();
            reader.onload = async () => {
              imageBase64 = reader.result;
              await addNewAd(imageBase64);
            };
            reader.readAsDataURL(file);
          } else {
            await addNewAd('');
          }
          async function addNewAd(img) {
            try {
              await addDoc(collection(db, "inzeraty"), {
                title: formData.get('title'),
                description: formData.get('description'),
                price: formData.get('price'),
                category: formData.get('category'),
                image: img,
                authorEmail: user.email,
                created: serverTimestamp()
              });
              form.reset();
              document.getElementById('msg').style.color = "green";
              document.getElementById('msg').textContent = "Inzerát byl přidán!";
              loadAds();
            } catch (err) {
              document.getElementById('msg').style.color = "crimson";
              document.getElementById('msg').textContent = "Chyba při ukládání: " + err.message;
            }
          }
        }
      } else {
        adFormSection.innerHTML = "<p>Pro přidání inzerátu se musíte <a href='prihlaseni.html'>přihlásit.</a></p>";
      }
      loadAds();
    });
  </script>
</body>
</html>